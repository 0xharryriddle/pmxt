name: Backfill Historical Releases

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/backfill-releases.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  backfill-releases:
    name: Create Releases for All Historical Tags
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Backfill All Missing Releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Starting backfill of all historical releases..."

          # Get all version tags, sorted naturally (handles v1.2 vs v1.10 correctly)
          TAGS=$(git tag -l 'v*' | sort -V)
          TOTAL=$(echo "$TAGS" | wc -l)
          CREATED=0
          SKIPPED=0

          echo "Found $TOTAL version tags"

          for tag in $TAGS; do
            # 1. Check if release already exists (Idempotency)
            if gh release view "$tag" &>/dev/null; then
              echo "[$((CREATED + SKIPPED + 1))/$TOTAL] Release exists for $tag - skipping"
              SKIPPED=$((SKIPPED + 1))
              continue
            fi

            echo "[$((CREATED + SKIPPED + 1))/$TOTAL] Creating release for tag: $tag"

            # 2. Extract version details
            VERSION=${tag#v}
            # Strip 'f' suffix if present
            [[ "$VERSION" == *f ]] && VERSION=${VERSION%f}

            # 3. Detect pre-release
            IS_PRERELEASE=""
            if [[ "$VERSION" =~ (alpha|beta|rc|a|b) ]]; then
              IS_PRERELEASE="--prerelease"
              echo "  → Pre-release detected"
            fi

            # 4. Robust Changelog Extraction
            # This awk logic prints lines strictly BETWEEN the version header and the next header (or EOF)
            # It avoids printing the headers themselves, removing the need for 'sed'
            RELEASE_NOTES=$(awk -v ver="## \[$VERSION\]" '
              $0 ~ ver { flag=1; next }           # Found start header, set flag, skip line
              /^## \[/ && flag { flag=0; exit }   # Found next header, clear flag, exit
              flag { print }                      # Print lines while flag is set
            ' changelog.md)
            
            # Trim leading/trailing whitespace from notes
            RELEASE_NOTES=$(echo "$RELEASE_NOTES" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')

            if [ -n "$RELEASE_NOTES" ]; then
                echo "  → Extracted changelog notes"
            else
                RELEASE_NOTES="Release $VERSION

See [changelog.md](https://github.com/$GITHUB_REPOSITORY/blob/main/changelog.md) for details."
                echo "  → No specific changelog entry found, using generic notes"
            fi

            # 5. Create the release body
            # Using a Here-Doc for cleaner formatting
            read -r -d '' RELEASE_BODY <<EOM
$RELEASE_NOTES

---

## Installation

**npm:**
\`\`\`bash
npm install pmxtjs@$VERSION
\`\`\`

**PyPI:**
\`\`\`bash
pip install pmxt==$VERSION
\`\`\`

## Links
- [npm: pmxtjs](https://www.npmjs.com/package/pmxtjs/v/$VERSION)
- [npm: pmxt-core](https://www.npmjs.com/package/pmxt-core/v/$VERSION)
- [PyPI: pmxt](https://pypi.org/project/pmxt/$VERSION/)

---

*This release was automatically generated from historical tags.*
EOM

            # 6. Create release
            # Added sleep 2 to be safer against secondary rate limits
            if echo "$RELEASE_BODY" | gh release create "$tag" \
              --title "v$VERSION" \
              --notes-file - \
              $IS_PRERELEASE \
              --verify-tag 2>/dev/null; then
              echo "  ✓ Successfully created release for $tag"
              CREATED=$((CREATED + 1))
            else
              echo "  ✗ Failed to create release for $tag"
            fi

            sleep 2
          done

          echo "========================================="
          echo "Backfill Complete! Created: $CREATED | Skipped: $SKIPPED"