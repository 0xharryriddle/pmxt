name: Backfill Historical Releases

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/backfill-releases.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  backfill-releases:
    name: Create Releases for All Historical Tags
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Backfill All Missing Releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Starting backfill of all historical releases..."

          # Get all version tags, sorted naturally
          TAGS=$(git tag -l 'v*' | sort -V)
          TOTAL=$(echo "$TAGS" | wc -l)
          CREATED=0
          SKIPPED=0

          echo "Found $TOTAL version tags"

          for tag in $TAGS; do
            # 1. Check if release already exists (Idempotency)
            if gh release view "$tag" &>/dev/null; then
              echo "[$((CREATED + SKIPPED + 1))/$TOTAL] Release exists for $tag - skipping"
              SKIPPED=$((SKIPPED + 1))
              continue
            fi

            echo "[$((CREATED + SKIPPED + 1))/$TOTAL] Creating release for tag: $tag"

            # 2. Extract version details
            VERSION=${tag#v}
            # Strip 'f' suffix if present
            [[ "$VERSION" == *f ]] && VERSION=${VERSION%f}

            # 3. Detect pre-release
            IS_PRERELEASE=""
            if [[ "$VERSION" =~ (alpha|beta|rc|a|b) ]]; then
              IS_PRERELEASE="--prerelease"
              echo "  → Pre-release detected"
            fi

            # 4. Robust Changelog Extraction
            # This awk logic prints lines strictly BETWEEN the version header and the next header
            RELEASE_NOTES=$(awk -v ver="## \[$VERSION\]" '
              $0 ~ ver { flag=1; next }           # Found start header, set flag, skip line
              /^## \[/ && flag { flag=0; exit }   # Found next header, clear flag, exit
              flag { print }                      # Print lines while flag is set
            ' changelog.md)
            
            # Trim leading/trailing whitespace
            RELEASE_NOTES=$(echo "$RELEASE_NOTES" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')

            if [ -z "$RELEASE_NOTES" ]; then
                RELEASE_NOTES="Release $VERSION"
                echo "  → No specific changelog entry found, using generic title"
            fi

            # 5. Create the release body file (Safe Method)
            echo "$RELEASE_NOTES" > release_body.md
            echo "" >> release_body.md
            echo "---" >> release_body.md
            echo "## Installation" >> release_body.md
            echo "**npm:**" >> release_body.md
            echo "\`\`\`bash" >> release_body.md
            echo "npm install pmxtjs@$VERSION" >> release_body.md
            echo "\`\`\`" >> release_body.md
            echo "**PyPI:**" >> release_body.md
            echo "\`\`\`bash" >> release_body.md
            echo "pip install pmxt==$VERSION" >> release_body.md
            echo "\`\`\`" >> release_body.md
            echo "## Links" >> release_body.md
            echo "- [npm: pmxtjs](https://www.npmjs.com/package/pmxtjs/v/$VERSION)" >> release_body.md
            echo "- [npm: pmxt-core](https://www.npmjs.com/package/pmxt-core/v/$VERSION)" >> release_body.md
            echo "- [PyPI: pmxt](https://pypi.org/project/pmxt/$VERSION/)" >> release_body.md
            echo "" >> release_body.md
            echo "---" >> release_body.md
            echo "*This release was automatically generated from historical tags.*" >> release_body.md

            # 6. Create release using the file
            if gh release create "$tag" \
              --title "v$VERSION" \
              --notes-file release_body.md \
              $IS_PRERELEASE \
              --verify-tag 2>/dev/null; then
              echo "  ✓ Successfully created release for $tag"
              CREATED=$((CREATED + 1))
            else
              echo "  ✗ Failed to create release for $tag"
            fi

            sleep 2
          done

          echo "========================================="
          echo "Backfill Complete! Created: $CREATED | Skipped: $SKIPPED"